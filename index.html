<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V13 - AI Dynamic Search</title>
    <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .scanner-window { position: relative; width: 280px; height: 280px; border-radius: 20px; overflow: hidden; background: #000; border: 3px solid #333; }
        video { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; object-fit: cover; transition: all 0.5s ease; }
        
        .scan-line { position: absolute; width: 100%; height: 3px; background: #0f0; box-shadow: 0 0 15px #0f0; top: 0; z-index: 10; animation: move-line 2s infinite linear; display: none; }
        @keyframes move-line { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        
        .ai-status { margin-top: 15px; font-size: 0.75rem; color: #ffeb3b; font-weight: bold; height: 30px; text-align: center; width: 280px; }
        .result-area { margin-top: 10px; width: 280px; padding: 15px; background: #1a1a1a; border-radius: 10px; border-left: 4px solid #0f0; text-align: center; min-height: 40px; word-break: break-all; }
        button { margin-top: 20px; width: 280px; padding: 16px; background: #0f0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h2>EscÃ¡ner Pro <span style="opacity: 0.6; font-size: 0.7em;">V13 DYNAMIC</span></h2>

    <div class="scanner-window">
        <video id="video" playsinline></video>
        <div id="laser" class="scan-line"></div>
    </div>

    <div id="ai-label" class="ai-status"></div>

    <div class="result-area" id="output">Esperando activaciÃ³n...</div>

    <button id="btn-start" onclick="startScanner()">INICIAR BÃšSQUEDA IA</button>

    <script>
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const video = document.getElementById('video');
        const aiLabel = document.getElementById('ai-label');
        const output = document.getElementById('output');
        
        let aiInterval;
        let currentState = 0;

        // Perfiles de Escaneo (IA Adaptativa)
        const aiProfiles = [
            { name: "MODO ESTÃNDAR", filter: "none" },
            { name: "IA: ALTO CONTRASTE (Luz fuerte)", filter: "contrast(1.8) grayscale(1)" },
            { name: "IA: MODO NOCTURNO (Baja luz)", filter: "brightness(1.5) contrast(1.3)" },
            { name: "IA: MODO BINARIO (QR DaÃ±ado)", filter: "threshold(0.5) grayscale(1) contrast(2)" }, // Simulado con contrast max
            { name: "IA: ENFOQUE AGRESIVO", filter: "saturate(0) contrast(1.4) brightness(0.9)" }
        ];

        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        async function startScanner() {
            document.getElementById('btn-start').style.display = 'none';
            document.getElementById('laser').style.display = 'block';
            aiLabel.innerText = aiProfiles[0].name;

            // Iniciar ciclo de cambio de ajustes cada 6 segundos
            aiInterval = setInterval(rotateAIProfiles, 6000);

            try {
                const devices = await codeReader.listVideoInputDevices();
                const backCamera = devices.find(d => /back|trasera|rear/i.test(d.label)) || devices[0];

                codeReader.decodeFromVideoDevice(backCamera.deviceId, 'video', (result, err) => {
                    if (result) {
                        clearInterval(aiInterval); // Detener rotaciÃ³n al tener Ã©xito
                        resetIA();
                        output.innerText = result.text;
                        playBeep();
                        if (navigator.vibrate) navigator.vibrate(100);
                    }
                });
            } catch (e) {
                output.innerText = "Error: " + e.message;
            }
        }

        function rotateAIProfiles() {
            currentState = (currentState + 1) % aiProfiles.length;
            const profile = aiProfiles[currentState];
            
            // Aplicar cambios visuales
            aiLabel.style.opacity = 0;
            setTimeout(() => {
                aiLabel.innerText = `ðŸ¤– ${profile.name}...`;
                video.style.filter = profile.filter;
                aiLabel.style.opacity = 1;
            }, 300);
            
            console.log(`Cambiando a perfil: ${profile.name}`);
        }

        function resetIA() {
            aiLabel.innerText = "âœ… CÃ“DIGO DETECTADO";
            aiLabel.style.color = "#0f0";
            video.style.filter = "none";
        }
    </script>
</body>
</html>
